# ============================================
# Docker Compose Configuration for Restaurant System
# ============================================
# This file orchestrates all services:
# - MySQL Database
# - Backend API (be_restaurant)
# - Admin Web Frontend (admin-web)
# - User Web Frontend (user-web)
# ============================================

# version: "3.8"  # Removed - obsolete in Docker Compose v2

services:
  # ============================================
  # MySQL Database Service
  # ============================================
  mysql:
    image: yobasystems/alpine-mariadb:10.11.8-8
    container_name: restaurant_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-restaurant_db}
      MYSQL_USER: ${MYSQL_USER:-restaurant_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-restaurant_password}
      TZ: Asia/Ho_Chi_Minh
    # No ports exposed - only accessible within Docker network
    volumes:
      - mysql_data:/var/lib/mysql
      - ./be_restaurant/data.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - app-network
    healthcheck:
      test:
        [
          "CMD",
          "mysql",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${MYSQL_ROOT_PASSWORD:-rootpassword}",
          "-e",
          "SELECT 1",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --innodb-buffer-pool-size=64M
      - --innodb-log-file-size=16M
      - --max-connections=30
      - --table-open-cache=100
      - --thread-cache-size=4
      - --tmp-table-size=8M
      - --max-heap-table-size=8M
      - --sort-buffer-size=1M
      - --read-buffer-size=512K
      - --read-rnd-buffer-size=512K
      - --join-buffer-size=1M
      - --key-buffer-size=4M
    deploy:
      resources:
        limits:
          memory: 192M
          cpus: "0.4"
        reservations:
          memory: 96M
          cpus: "0.2"

  # ============================================
  # Chatbot Service (Python FastAPI)
  # ============================================
  chatbot:
    build:
      context: ./chatbot
      dockerfile: Dockerfile
    container_name: restaurant_chatbot
    restart: unless-stopped
    # No ports exposed - only accessible within Docker network
    environment:
      # Backend URL using Docker service name
      BE_URL: http://backend:8000/api
      PYTHONUNBUFFERED: 1
    volumes:
      - ./chatbot/chatbot.log:/app/chatbot.log
      - ./chatbot/hiwell_chatbot.db:/app/hiwell_chatbot.db
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:7860/api/health', timeout=5)",
        ]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 192M
          cpus: "0.25"
        reservations:
          memory: 96M
          cpus: "0.1"

  # ============================================
  # Backend API Service (be_restaurant)
  # ============================================
  backend:
    build:
      context: ./be_restaurant
      dockerfile: Dockerfile
    container_name: restaurant_backend
    restart: unless-stopped
    ports:
      - "${PORT:-8000}:8000"
    env_file:
      - ./be_restaurant/.env
    environment:
      # Override DB_HOST to use Docker service name for network communication
      DB_HOST: mysql
      DB_PORT: ${MYSQL_PORT:-3306}
      DB_NAME: ${MYSQL_DATABASE:-restaurant_db}
      DB_USER: ${MYSQL_USER:-restaurant_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-restaurant_password}
      # Chatbot URL using Docker service name (must include /api prefix)
      CHATBOT_URL: http://chatbot:7860/api
      CLIENT_ADMIN_URL: http://localhost:3001
      CLIENT_USER_URL: http://localhost:3000
      VNP_RETURN_URL_ORDER: http://localhost:8000/api/payments/vnpay/return
      VNP_RETURN_URL_RESERVATION: http://localhost:8000/api/payments/vnpay/return
    volumes:
      - ./be_restaurant/uploads:/app/uploads
      - ./be_restaurant/logs:/app/logs
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy
      chatbot:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:8000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 45s
      timeout: 10s
      retries: 2
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 320M
          cpus: "0.4"
        reservations:
          memory: 192M
          cpus: "0.2"

  # ============================================
  # Admin Web Frontend Service
  # ============================================
  admin-web:
    build:
      context: ./admin-web
      dockerfile: Dockerfile
      args:
        # Build args - pass API URL for build-time embedding
        # For Docker network, use backend service name
        NEXT_PUBLIC_API_URL: http://localhost:8000
        NEXT_PUBLIC_USER_WEB_URL: http://localhost:3000
    container_name: restaurant_admin_web
    restart: unless-stopped
    ports:
      - "${ADMIN_WEB_PORT:-3001}:3001"
    environment:
      # Runtime environment variables
      NODE_ENV: production
    networks:
      - app-network
    depends_on:
      backend:
        condition: service_healthy
    # Health check defined in Dockerfile
    deploy:
      resources:
        limits:
          memory: 96M
          cpus: "0.15"
        reservations:
          memory: 48M
          cpus: "0.1"

  # ============================================
  # User Web Frontend Service
  # ============================================
  user-web:
    build:
      context: ./user-web
      dockerfile: Dockerfile
      args:
        # Build args - pass API URL for build-time embedding
        # For Docker network, use backend service name
        NEXT_PUBLIC_API_URL: http://localhost:8000
    container_name: restaurant_user_web
    restart: unless-stopped
    ports:
      - "${USER_WEB_PORT:-3000}:3000"
    environment:
      # Runtime environment variables
      NODE_ENV: production
    networks:
      - app-network
    depends_on:
      backend:
        condition: service_healthy
    # Health check defined in Dockerfile
    deploy:
      resources:
        limits:
          memory: 96M
          cpus: "0.15"
        reservations:
          memory: 48M
          cpus: "0.1"

# ============================================
# Networks
# ============================================
networks:
  app-network:
    driver: bridge
    name: restaurant_network

# ============================================
# Volumes
# ============================================
volumes:
  mysql_data:
    name: restaurant_mysql_data
    driver: local
