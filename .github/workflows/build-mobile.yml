name: Build Mobile Apps

on:
  push:
    tags:
      - 'v*' # Trigger khi tag báº¯t Ä‘áº§u báº±ng 'v' (vÃ­ dá»¥: v1.0.0)
  workflow_dispatch: # Cho phÃ©p trigger thá»§ cÃ´ng
    inputs:
      build_flutter:
        description: 'Build Flutter app (user-app)'
        required: false
        type: boolean
        default: true
      build_expo:
        description: 'Build Expo app (admin-app)'
        required: false
        type: boolean
        default: true
      platform:
        description: 'Platform to build'
        required: false
        type: choice
        options:
          - android
          - ios
          - both
        default: android

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  # Build Flutter App (user-app)
  build-flutter:
    name: Build Flutter App (user-app)
    runs-on: ubuntu-latest
    if: |
      (startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build_flutter == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        working-directory: ./user-app/restaurant_reservation_app
        run: flutter pub get

      - name: Verify Flutter installation
        run: flutter doctor -v

      - name: Setup Android Keystore (if provided)
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        working-directory: ./user-app/restaurant_reservation_app
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
          echo "âœ… Keystore file created"

      - name: Build Flutter APK (Release)
        working-directory: ./user-app/restaurant_reservation_app
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          if [ -f "android/app/keystore.jks" ]; then
            echo "ğŸ” Building signed APK..."
            flutter build apk --release --split-per-abi
          else
            echo "âš ï¸ No keystore found, building unsigned APK..."
            flutter build apk --release --split-per-abi
          fi

      - name: Build Flutter AAB (Release) - for Play Store
        working-directory: ./user-app/restaurant_reservation_app
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          if [ -f "android/app/keystore.jks" ]; then
            echo "ğŸ” Building signed AAB..."
            flutter build appbundle --release || echo "AAB build failed, continuing..."
          else
            echo "âš ï¸ Skipping AAB build (no keystore)"
          fi

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-apk-release
          path: |
            user-app/restaurant_reservation_app/build/app/outputs/flutter-apk/*.apk
            user-app/restaurant_reservation_app/build/app/outputs/bundle/release/*.aab
          retention-days: 90

      - name: Upload AAB artifacts (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: flutter-aab-release
          path: user-app/restaurant_reservation_app/build/app/outputs/bundle/release/*.aab
          if-no-files-found: ignore
          retention-days: 90

      - name: Create Release Notes
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "## Flutter App Build (user-app)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ **Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- APK files: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- AAB file: Available in artifacts (if keystore configured)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # Build Expo App (admin-app)
  build-expo:
    name: Build Expo App (admin-app)
    runs-on: ubuntu-latest
    if: |
      (startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build_expo == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: admin-app/package-lock.json

      - name: Install dependencies
        working-directory: ./admin-app
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Login to Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android APK with EAS
        working-directory: ./admin-app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build --platform android \
            --non-interactive \
            --profile production \
            --no-wait || echo "Build initiated, check EAS dashboard for status"

      - name: Build iOS with EAS (if platform is ios or both)
        if: |
          (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both') ||
          startsWith(github.ref, 'refs/tags/v')
        working-directory: ./admin-app
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build --platform ios \
            --non-interactive \
            --profile production \
            --no-wait || echo "iOS build initiated, check EAS dashboard for status"

      - name: Create Release Notes
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "## Expo App Build (admin-app)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build initiated successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“± **Platforms:**" >> $GITHUB_STEP_SUMMARY
          echo "- Android: Check EAS dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: Check EAS dashboard (if enabled)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **EAS Dashboard:** https://expo.dev/accounts/[your-account]/projects/restaurant-admin/builds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”– **Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-flutter, build-expo]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download Flutter APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: flutter-apk-release
          path: ./artifacts/flutter-apk

      - name: Download Flutter AAB artifacts
        uses: actions/download-artifact@v4
        with:
          name: flutter-aab-release
          path: ./artifacts/flutter-aab
          continue-on-error: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸš€ Mobile Apps Release ${{ github.ref_name }}

            ### ğŸ“¦ Artifacts

            #### Flutter App (user-app)
            - APK files attached below
            - AAB file attached (if available)

            #### Expo App (admin-app)
            - Check [EAS Dashboard](https://expo.dev) for build status
            - Builds are processed asynchronously

            ### ğŸ“ Changes
            - See commit history for details

            ### ğŸ”— Download
            - Download APK/AAB files from the assets below
          files: |
            artifacts/flutter-apk/**
            artifacts/flutter-aab/**
          draft: false
          prerelease: false

      - name: Release Summary
        run: |
          echo "âœ… GitHub Release created successfully!"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

