name: Deploy Restaurant System to Azure VM

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_FILE: docker-compose.prod.yml

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.AZURE_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} \
            "echo 'SSH OK'"

      - name: Upload project to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ \
            ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }}:${{ secrets.AZURE_DEPLOY_PATH }}

      - name: Execute deploy script on server
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} << 'EOF'
            
          set -e
          cd ${{ secrets.AZURE_DEPLOY_PATH }}

          echo "Using docker compose version:"
          docker compose version || docker-compose version

          # Select the right compose command
          if docker compose version >/dev/null 2>&1; then
            CMD="docker compose"
          else
            CMD="docker-compose"
          fi

          echo "Stopping old containers..."
          $CMD -f docker-compose.prod.yml down || true

          echo "Pruning old images..."
          docker image prune -af --filter "until=24h" || true

          echo "Rebuilding images..."
          DOCKER_BUILDKIT=1 $CMD -f docker-compose.prod.yml build

          echo "Starting services..."
          $CMD -f docker-compose.prod.yml up -d

          echo "Waiting for backend health..."
          for i in {1..20}; do
            if curl -f http://localhost:8000/health >/dev/null 2>&1; then
              echo "Backend is healthy!"
              exit 0
            fi
            echo "Retry $i..."
            sleep 6
          done

          echo "Health check failed!"
          exit 1

          EOF

      - name: Deployment Result
        if: always()
        run: echo "Job Status: ${{ job.status }}"
