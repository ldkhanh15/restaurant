# ============================================
# Production Docker Compose Configuration
# Optimized for AWS EC2 t3.micro (1 vCPU, 1GB RAM)
# ============================================

# version: "3.8"  # Removed - obsolete in Docker Compose v2

services:
  # ============================================
  # MySQL Database Service
  # ============================================
  mysql:
    image: yobasystems/alpine-mariadb:10.11.8-8
    container_name: restaurant_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-restaurant_db}
      MYSQL_USER: ${MYSQL_USER:-restaurant_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-restaurant_password}
      TZ: Asia/Ho_Chi_Minh
    volumes:
      - mysql_data:/var/lib/mysql
      - ./be_restaurant/data.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - app-network
    healthcheck:
      test:
        [
          "CMD",
          "mysql",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${MYSQL_ROOT_PASSWORD:-rootpassword}",
          "-e",
          "SELECT 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 90s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --innodb-buffer-pool-size=128M
      - --innodb-log-file-size=32M
      - --max-connections=50
      - --table-open-cache=200
      - --thread-cache-size=8
      - --tmp-table-size=16M
      - --max-heap-table-size=16M
      - --sort-buffer-size=2M
      - --read-buffer-size=1M
      - --read-rnd-buffer-size=1M
      - --join-buffer-size=2M
      - --key-buffer-size=8M
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"

  # ============================================
  # Chatbot Service
  # ============================================
  chatbot:
    build:
      context: ./chatbot
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: restaurant_chatbot
    restart: unless-stopped
    environment:
      BE_URL: http://backend:8000/api
      PYTHONUNBUFFERED: 1
    volumes:
      - ./chatbot/chatbot.log:/app/chatbot.log
      - ./chatbot/hiwell_chatbot.db:/app/hiwell_chatbot.db
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:7860/api/health', timeout=5)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.3"
        reservations:
          memory: 128M
          cpus: "0.1"

  # ============================================
  # Backend API Service
  # ============================================
  backend:
    build:
      context: ./be_restaurant
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    container_name: restaurant_backend
    restart: unless-stopped
    ports:
      - "${PORT:-8000}:8000"
    env_file:
      - ./be_restaurant/.env
    environment:
      DB_HOST: mysql
      DB_PORT: ${MYSQL_PORT:-3306}
      DB_NAME: ${MYSQL_DATABASE:-restaurant_db}
      DB_USER: ${MYSQL_USER:-restaurant_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-restaurant_password}
      CHATBOT_URL: http://chatbot:7860/api
      CLIENT_ADMIN_URL: ${CLIENT_ADMIN_URL:-https://98.91.23.236:3001}
      CLIENT_USER_URL: ${CLIENT_USER_URL:-https://98.91.23.236:3000}
      VNP_RETURN_URL_ORDER: ${VNP_RETURN_URL_ORDER:-https://98.91.23.236:8000/api/payments/vnpay/return}
      VNP_RETURN_URL_RESERVATION: ${VNP_RETURN_URL_RESERVATION:-https://98.91.23.236:8000/api/payments/vnpay/return}
    volumes:
      - ./be_restaurant/uploads:/app/uploads
      - ./be_restaurant/logs:/app/logs
    networks:
      - app-network
    depends_on:
      mysql:
        condition: service_healthy
      chatbot:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:8000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: "0.5"
        reservations:
          memory: 256M
          cpus: "0.25"

  # ============================================
  # Admin Web Frontend Service
  # ============================================
  admin-web:
    build:
      context: ./admin-web
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://98.91.23.236:8000}
        BUILDKIT_INLINE_CACHE: 1
    container_name: restaurant_admin_web
    restart: unless-stopped
    ports:
      - "${ADMIN_WEB_PORT:-3001}:3001"
    environment:
      NODE_ENV: production
    networks:
      - app-network
    depends_on:
      backend:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"
        reservations:
          memory: 64M
          cpus: "0.1"

  # ============================================
  # User Web Frontend Service
  # ============================================
  user-web:
    build:
      context: ./user-web
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://98.91.23.236:8000}
        BUILDKIT_INLINE_CACHE: 1
    container_name: restaurant_user_web
    restart: unless-stopped
    ports:
      - "${USER_WEB_PORT:-3000}:3000"
    environment:
      NODE_ENV: production
    networks:
      - app-network
    depends_on:
      backend:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"
        reservations:
          memory: 64M
          cpus: "0.1"

# ============================================
# Networks
# ============================================
networks:
  app-network:
    driver: bridge
    name: restaurant_network

# ============================================
# Volumes
# ============================================
volumes:
  mysql_data:
    driver: local
